// =====================================================================
//  ALTO PARAN√Å ¬∑ STOCK DE CARBONO ‚ÄúBOSQUE PURO‚Äù (300 m)
//  Usamos AGB global NASA/ORNL + m√°scara MapBiomas clase 3 ‚â• 1 ha 
//  ‚Üí Calculamos s√≥lo sobre p√≠xeles 300 m con > 50 % bosque
// =====================================================================

// 1Ô∏è‚É£ Define regi√≥n y carga MapBiomas (30 m)
var region = ee.FeatureCollection('FAO/GAUL/2015/level1')
                .filter(ee.Filter.eq('ADM0_NAME','Paraguay'))
                .filter(ee.Filter.eq('ADM1_NAME','Alto Parana'))
                .geometry();

var mb = ee.Image(
  'projects/mapbiomas-public/assets/paraguay/collection1/' +
  'mapbiomas_paraguay_collection1_integration_v1'
);

// 2Ô∏è‚É£ M√°scara de bosque clase 3 ‚â• 1 ha a 30 m
function bosque30m(year) {
  var band = (year <= 2022) ? 'classification_'+year : 'classification_2022';
  var b3   = mb.select(band).eq(3);
  return b3
    .connectedPixelCount(12, true).gte(12)  // ‚â•12 px √ó30 m ‚âÉ1 ha
    .and(b3)
    .selfMask()
    .clip(region);
}
var bosque30 = bosque30m(2022);

// 3Ô∏è‚É£ C√°lculo de fracci√≥n de bosque en ventana 300 m √ó 300 m
//    (ventana de radio 150 m, kernel cuadrado)
var bosqueFrac = bosque30.reduceNeighborhood({
  reducer: ee.Reducer.mean(),
  kernel: ee.Kernel.square({radius:150, units:'meters'})
});

// 4Ô∏è‚É£ Reproyecto esa fracci√≥n a la grilla 300 m de AGB
//    (proyecci√≥n y escala de NASA/ORNL)
var agb2010 = ee.ImageCollection('NASA/ORNL/biomass_carbon_density/v1')
               .select('agb').first();

var bosqueFrac300 = bosqueFrac
  .reproject({
    crs: agb2010.projection(),
    scale: 300
  });

// 5Ô∏è‚É£ Enmascaro AGB s√≥lo donde fracci√≥n de bosque > 0.5
var agbBosquePuro = agb2010.updateMask(bosqueFrac300.gt(0.5));

// 6Ô∏è‚É£ Calculo el promedio de AGB (Mg C/ha) sobre estos p√≠xeles ‚Äúpuros‚Äù
var stats = agbBosquePuro.reduceRegion({
  reducer: ee.Reducer.mean(),
  geometry: region,
  scale:    300,
  maxPixels: 1e13
});

var mgC_ha   = ee.Number(stats.get('agb'));
var tCO2e_ha = mgC_ha.multiply(44/12);

print('AGB bosque puro (Mg C/ha):',    mgC_ha);
print('Stock bosque puro (t CO‚ÇÇe/ha):', tCO2e_ha);

// 7Ô∏è‚É£ (Opcional) Visualizaci√≥n
Map.centerObject(region, 8);
Map.addLayer(
  bosqueFrac300, 
  {min:0, max:1, palette: ['ffffff','006400']}, 
  'Fracci√≥n bosque 300 m'
);
Map.addLayer(
  agbBosquePuro, 
  {min:0, max:200}, 
  'AGB bosque puro (Mg C/ha)'
);

// üî∏ 8Ô∏è‚É£ Muestreo de cada p√≠xel y exportaci√≥n a CSV
var samples = agbBosquePuro
  .select('agb')             // banda con el valor Mg C/ha
  .sample({
    region:    region,       // tu geometr√≠a de Alto Paran√°
    scale:     300,          // resoluci√≥n de la imagen
    projection: agb2010.projection(), // asegura la misma rejilla
    geometries: true         // incluye la geometr√≠a (centro de cada pixel)
  });

Export.table.toDrive({
  collection: samples,
  description: 'AGB_BosquePuro_Pixels_300m',
  folder:      'deg alto parana',
  fileFormat: 'CSV'
});

